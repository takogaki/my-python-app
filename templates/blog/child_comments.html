{% load comment_tags %}
{% load youtube_extras %}

{% for comment in comments %}
<div class="comment parent">

    <p>
        <strong>{{ comment.name|default:"匿名" }}</strong><br>
        {{ comment.body }}
    </p>

    {% if comment.replies.exists %}
    <button type="button" class="show-replies-button" onclick="toggleReplies({{ comment.id }})">
        返信を見る（{{ comment.replies.count }}件）
    </button>
    {% endif %}

    <div class="media-wrapper">

        {% if comment.image %}
        <img src="{{ comment.image.url }}" class="comment-media-thumb"
            onclick="openMedia('{{ comment.image.url }}', 'image')">
        {% endif %}

        {% if comment.video_url %}
        
            {% if "youtube.com" in comment.video_url or "youtu.be" in comment.video_url %}
            <iframe width="100%" height="315"
                src="https://www.youtube.com/embed/{{ comment.video_url|cut:'https://www.youtube.com/watch?v='|cut:'https://youtu.be/' }}"
                frameborder="0" allowfullscreen>
            </iframe>
            
            {% elif "tiktok.com" in comment.video_url %}
            <blockquote class="tiktok-embed" cite="{{ comment.video_url }}" data-video-id="">
                <a href="{{ comment.video_url }}"></a>
            </blockquote>
            <script async src="https://www.tiktok.com/embed.js"></script>
            
            {% elif "instagram.com" in comment.video_url %}
            <blockquote class="instagram-media" data-instgrm-permalink="{{ comment.video_url }}" data-instgrm-version="14">
                <a href="{{ comment.video_url }}"></a>
            </blockquote>
            <script async src="https://www.instagram.com/embed.js"></script>
            
            {% elif "x.com" in comment.video_url or "twitter.com" in comment.video_url %}
            <blockquote class="twitter-tweet">
                <a href="{{ comment.video_url }}"></a>
            </blockquote>
            <script async src="https://platform.twitter.com/widgets.js"></script>
            
            {% elif "facebook.com" in comment.video_url %}
            <iframe src="https://www.facebook.com/plugins/video.php?href={{ comment.video_url|urlencode }}" width="100%" height="315"
                style="border:none;overflow:hidden" scrolling="no" frameborder="0" allowfullscreen>
            </iframe>
            
            {% endif %}

            <p>
                <a href="{{ comment.video_url }}" target="_blank" rel="noopener">
                    ▶ 動画を開く
                </a>
            </p>
        
        {% endif %}

    </div>

    <!-- 子コメント（返信） -->
    <div id="replies-{{ comment.id }}" style="display:none; margin-left:20px;">

        {% for reply in comment.replies.all %}
        <div class="comment reply">

            <p>
                ∟ <strong>{{ reply.name|default:"匿名" }}</strong>
                {% if reply.reply_to %}
                ＞＞＞ <strong>{{ reply.reply_to }}</strong>
                {% endif %}
                <br>
                {{ reply.body }}
            </p>

            {% if reply.image %}
            <img src="{{ reply.image.url }}" class="comment-media-thumb">
            {% endif %}

            {% if reply.video_url %}
            
                {% if "youtube.com" in reply.video_url or "youtu.be" in reply.video_url %}
                <iframe width="100%" height="315"
                    src="https://www.youtube.com/embed/{{ reply.video_url|cut:'https://www.youtube.com/watch?v='|cut:'https://youtu.be/' }}"
                    frameborder="0" allowfullscreen>
                </iframe>
                
                {% elif "tiktok.com" in reply.video_url %}
                <blockquote class="tiktok-embed" cite="{{ reply.video_url }}" data-video-id="">
                    <a href="{{ reply.video_url }}"></a>
                </blockquote>
                <script async src="https://www.tiktok.com/embed.js"></script>
                
                {% elif "instagram.com" in reply.video_url %}
                <blockquote class="instagram-media" data-instgrm-permalink="{{ reply.video_url }}" data-instgrm-version="14">
                    <a href="{{ reply.video_url }}"></a>
                </blockquote>
                <script async src="https://www.instagram.com/embed.js"></script>
                
                {% elif "x.com" in reply.video_url or "twitter.com" in reply.video_url %}
                <blockquote class="twitter-tweet">
                    <a href="{{ reply.video_url }}"></a>
                </blockquote>
                <script async src="https://platform.twitter.com/widgets.js"></script>
                
                {% elif "facebook.com" in reply.video_url %}
                <iframe src="https://www.facebook.com/plugins/video.php?href={{ reply.video_url|urlencode }}" width="100%" height="315"
                    style="border:none;overflow:hidden" scrolling="no" frameborder="0" allowfullscreen>
                </iframe>
                
                {% endif %}

                <p>
                    <a href="{{ reply.video_url }}" target="_blank" rel="noopener">
                        ▶ 動画を開く
                    </a>
                </p>
            
            {% endif %}

            <!-- 返信への返信 -->
            <button type="button" onclick="toggleReply({{ reply.id }})">
                返信
            </button>

            <div id="reply-form-{{ reply.id }}" style="display:none; margin-left:20px;">
                <form method="post" enctype="multipart/form-data">
                    {% csrf_token %}
                    {{ form.as_p }}
                    <input type="hidden" name="parent_id" value="{{ comment.id }}">
                    <input type="hidden" name="reply_to" value="{{ reply.name }}">
                    <button type="submit">送信</button>
                </form>
            </div>

        </div>
        {% endfor %}

    </div>

    <!-- 親コメントへの返信 -->
    <button type="button" onclick="toggleReply({{ comment.id }})">
        返信
    </button>

    <div id="reply-form-{{ comment.id }}" style="display:none; margin-left:20px;">
        <form method="post" enctype="multipart/form-data">
            {% csrf_token %}
            {{ form.as_p }}
            <input type="hidden" name="parent_id" value="{{ comment.id }}">
            <input type="hidden" name="reply_to" value="{{ comment.name }}">
            <button type="submit">送信</button>
        </form>
    </div>

</div>
<hr>
{% empty %}
<p>コメントはまだありません。</p>
{% endfor %}

<script async src="https://www.tiktok.com/embed.js"></script>
<script async src="//www.instagram.com/embed.js"></script>
<script async src="https://platform.twitter.com/widgets.js"></script>