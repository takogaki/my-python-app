{% load comment_tags %}

<style>
    /* コメント共通 */
.comment {
    padding: 12px 14px;
    border-radius: 8px;
    border-left: 4px solid #cbd5e1;
    transition: background-color 0.2s;
}

/* シマシマ（奇数） */
.comment:nth-of-type(odd) {
    background-color: #f9fafb;
}

/* シマシマ（偶数） */
.comment:nth-of-type(even) {
    background-color: #eef2ff;
}

/* ホバー時 */
.comment:hover {
    background-color: #dde7ff;
}

/* 投稿者名 */
.comment strong {
    font-size: 0.95rem;
    color: #1f2937;
}

/* 投稿日時 */
.comment small {
    font-size: 0.75rem;
    color: #6b7280;
}

/* 返信ボタン */
.comment button {
    margin-top: 6px;
    font-size: 0.8rem;
    background: none;
    border: none;
    color: #2563eb;
    cursor: pointer;
}

.comment button:hover {
    text-decoration: underline;
}

/* 深い階層ほど色を少し変える */
.comment[style*="60px"] {
    border-left-color: #93c5fd;
    background-color: #f0f7ff;
}

.comment[style*="90px"] {
    border-left-color: #60a5fa;
    background-color: #e6f0ff;
}

.media-wrapper {
    display: flex;
    flex-direction: column;
    gap: 8px;
    margin-top: 8px;
}

.comment-media-thumb {
    max-width: 160px;
    cursor: pointer;
    border-radius: 6px;
}

.video-thumb {
    display: inline-block;
    cursor: pointer;
    padding: 6px 10px;
    background: #222;
    color: #fff;
    border-radius: 6px;
    font-size: 14px;
}

</style>

{% load comment_tags %}

{% for comment in comments %}
<div class="comment parent">

    <p>
        <strong>{{ comment.name }}</strong><br>
        {{ comment.body }}
    </p>

    <!-- 返信を見るボタン -->
    {% if comment.replies.all %}
    <button type="button" class="show-replies-button" onclick="toggleReplies({{ comment.id }})">
        返信を見る（{{ comment.replies.count }}件）
    </button>
    {% endif %}

        <div class="media-wrapper">
        
            {% if comment.image %}
            <img src="{{ comment.image.url }}" class="comment-media-thumb"
                onclick="openMedia('{{ comment.image.url }}', 'image')">
            {% endif %}
        
            {% if comment.video %}
            <div class="video-thumb" onclick="openMedia('{{ comment.video.url }}', 'video')">
                ▶ 動画を見る
            </div>
            {% endif %}
        
        </div>


    <!-- 返信一覧（最初は非表示） -->
    <div id="replies-{{ comment.id }}" style="display:none; margin-left:20px;">

        {% for reply in comment.replies.all|dictsort:"posted_date" %}
        <div class="comment reply">
        
            <p>
                ∟ <strong>{{ reply.name }}</strong>
                ＞＞＞ <strong>{{ reply.reply_to }}</strong><br>
                {{ reply.body }}
            </p>
        
            {% if reply.image %}
            <img src="{{ reply.image.url }}" class="comment-media-thumb" onclick="openMedia('{{ reply.image.url }}', 'image')">
            {% endif %}
        
            {% if reply.video %}
            <div class="video-thumb" onclick="openMedia('{{ reply.video.url }}', 'video')">
                ▶ 動画を見る
            </div>
            {% endif %}
        
            <!-- 返信への返信 -->
            <button type="button" onclick="toggleReply({{ reply.id }})">
                返信
            </button>
        
            <div id="reply-form-{{ reply.id }}" style="display:none; margin-left:20px;">
                <form method="post" enctype="multipart/form-data">
                    {% csrf_token %}
                    {{ form.as_p }}
                    <input type="hidden" name="parent_id" value="{{ comment.id }}">
                    <input type="hidden" name="reply_to" value="{{ reply.name }}">
                    <button type="submit">送信</button>
                </form>
            </div>
        
        </div>
        {% endfor %}

    </div>

    <!-- 親コメントへの返信 -->
    <button type="button" onclick="toggleReply({{ comment.id }})">
        返信
    </button>

    <div id="reply-form-{{ comment.id }}" style="display:none; margin-left:20px;">
        <form method="post" enctype="multipart/form-data">
            {% csrf_token %}
            {{ form.as_p }}
            <input type="hidden" name="parent_id" value="{{ comment.id }}">
            <input type="hidden" name="reply_to" value="{{ comment.name }}">
            <button type="submit">送信</button>
        </form>
    </div>

</div>
<hr>
{% endfor %}


</div>