{% load comment_tags %}
{% load youtube_extras %}

{% for comment in comments %}
<div class="comment parent">

    <p>
        <strong>{{ comment.name|default:"匿名" }}</strong><br>
        {{ comment.body }}
    </p>

    {% if comment.replies.exists %}
    <button type="button" class="show-replies-button" onclick="toggleReplies({{ comment.id }})">
        返信を見る（{{ comment.replies.count }}件）
    </button>
    {% endif %}

    <div class="media-wrapper">

        {% if comment.image %}
        <img src="{{ comment.image.url }}" class="comment-media-thumb"
            onclick="openMedia('{{ comment.image.url }}', 'image')">
        {% endif %}

        {% if comment.youtube_url %}
        <div class="video-wrapper">
            <iframe src="https://www.youtube.com/embed/{{ comment.youtube_url|youtube_id }}" frameborder="0"
                allowfullscreen loading="lazy">
            </iframe>
        </div>
        {% endif %}

    </div>

    <!-- 子コメント（返信） -->
    <div id="replies-{{ comment.id }}" style="display:none; margin-left:20px;">

        {% for reply in comment.replies.all %}
        <div class="comment reply">

            <p>
                ∟ <strong>{{ reply.name|default:"匿名" }}</strong>
                {% if reply.reply_to %}
                ＞＞＞ <strong>{{ reply.reply_to }}</strong>
                {% endif %}
                <br>
                {{ reply.body }}
            </p>

            {% if reply.image %}
            <img src="{{ reply.image.url }}" class="comment-media-thumb">
            {% endif %}

            {% if reply.youtube_url %}
            <div class="video-wrapper">
                <iframe src="https://www.youtube.com/embed/{{ reply.youtube_url|youtube_id }}" frameborder="0"
                    allowfullscreen loading="lazy">
                </iframe>
            </div>
            {% endif %}

            <!-- 返信への返信 -->
            <button type="button" onclick="toggleReply({{ reply.id }})">
                返信
            </button>

            <div id="reply-form-{{ reply.id }}" style="display:none; margin-left:20px;">
                <form method="post" enctype="multipart/form-data">
                    {% csrf_token %}
                    {{ form.as_p }}
                    <input type="hidden" name="parent_id" value="{{ comment.id }}">
                    <input type="hidden" name="reply_to" value="{{ reply.name }}">
                    <button type="submit">送信</button>
                </form>
            </div>

        </div>
        {% endfor %}

    </div>

    <!-- 親コメントへの返信 -->
    <button type="button" onclick="toggleReply({{ comment.id }})">
        返信
    </button>

    <div id="reply-form-{{ comment.id }}" style="display:none; margin-left:20px;">
        <form method="post" enctype="multipart/form-data">
            {% csrf_token %}
            {{ form.as_p }}
            <input type="hidden" name="parent_id" value="{{ comment.id }}">
            <input type="hidden" name="reply_to" value="{{ comment.name }}">
            <button type="submit">送信</button>
        </form>
    </div>

</div>
<hr>
{% empty %}
<p>コメントはまだありません。</p>
{% endfor %}