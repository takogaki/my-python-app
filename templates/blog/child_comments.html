{% load comment_tags %}

{% load static %}
<link rel="stylesheet" href="{% static 'blog/css/blog.css' %}">

{% load comment_tags %}

{% for comment in comments %}
<div class="comment parent">

    <p>
        <strong>{{ comment.name }}</strong><br>
        {{ comment.body }}
    </p>

    <!-- 返信を見るボタン -->
    {% if comment.replies.all %}
    <button type="button" class="show-replies-button" onclick="toggleReplies({{ comment.id }})">
        返信を見る（{{ comment.replies.count }}件）
    </button>
    {% endif %}

        <div class="media-wrapper">
        
            {% if comment.image %}
            <img src="{{ comment.image.url }}" class="comment-media-thumb"
                onclick="openMedia('{{ comment.image.url }}', 'image')">
            {% endif %}
        
            {% if comment.video %}
            <div class="video-thumb" onclick="openMedia('{{ comment.video.url }}', 'video')">
                ▶ 動画を見る
            </div>
            {% endif %}
        
        </div>


    <!-- 返信一覧（最初は非表示） -->
    <div id="replies-{{ comment.id }}" style="display:none; margin-left:20px;">

        {% for reply in comment.replies.all|dictsort:"posted_date" %}
        <div class="comment reply">
        
            <p>
                ∟ <strong>{{ reply.name }}</strong>
                ＞＞＞ <strong>{{ reply.reply_to }}</strong><br>
                {{ reply.body }}
            </p>
        
            {% if reply.image %}
            <img src="{{ reply.image.url }}" class="comment-media-thumb" onclick="openMedia('{{ reply.image.url }}', 'image')">
            {% endif %}
        
            {% if reply.video %}
            <div class="video-thumb" onclick="openMedia('{{ reply.video.url }}', 'video')">
                ▶ 動画を見る
            </div>
            {% endif %}
        
            <!-- 返信への返信 -->
            <button type="button" onclick="toggleReply({{ reply.id }})">
                返信
            </button>
        
            <div id="reply-form-{{ reply.id }}" style="display:none; margin-left:20px;">
                <form method="post" enctype="multipart/form-data">
                    {% csrf_token %}
                    {{ form.as_p }}
                    <input type="hidden" name="parent_id" value="{{ comment.id }}">
                    <input type="hidden" name="reply_to" value="{{ reply.name }}">
                    <button type="submit">送信</button>
                </form>
            </div>
        
        </div>
        {% endfor %}

    </div>

    <!-- 親コメントへの返信 -->
    <button type="button" onclick="toggleReply({{ comment.id }})">
        返信
    </button>

    <div id="reply-form-{{ comment.id }}" style="display:none; margin-left:20px;">
        <form method="post" enctype="multipart/form-data">
            {% csrf_token %}
            {{ form.as_p }}
            <input type="hidden" name="parent_id" value="{{ comment.id }}">
            <input type="hidden" name="reply_to" value="{{ comment.name }}">
            <button type="submit">送信</button>
        </form>
    </div>

</div>
<hr>
{% endfor %}


</div>